# Lab 5.3 - Installing and Configuring Alert Manager on Linux

In this lab, we will walk you through the installation and configuration of **Alert Manager** on a Linux system. Alert Manager is an essential tool used with **Prometheus** to handle alerts generated from monitoring data. It enables you to group, route, and notify about critical alerts in your infrastructure.

By the end of this lab, you will:
1. Install and configure Alert Manager.
2. Set up email notifications using Gmail.
3. Run Alert Manager as a service.
4. Verify the integration between Prometheus and Alert Manager.

Let's begin!

---

## Step-by-Step Instructions

### Step 1: Install Alert Manager

We'll start by downloading and installing **Alert Manager** on **node1**.

#### 1.1 Switch to the Root User and Navigate to `/opt`

Switch to the root user to ensure proper permissions during the installation:

```bash
sudo su -
```

Navigate to the `/opt` directory, where we will download and install Alert Manager:

```bash
cd /opt
```

#### 1.2 Download and Extract Alert Manager

Next, download the Alert Manager package (v0.25.0 in this case):

```bash
wget https://github.com/prometheus/alertmanager/releases/download/v0.25.0/alertmanager-0.25.0.linux-amd64.tar.gz
```

Once downloaded, extract the tarball:

```bash
tar xvfz alertmanager-0.25.0.linux-amd64.tar.gz
```

This will extract the Alert Manager files into the `alertmanager-0.25.0.linux-amd64` directory.

---

### Step 2: Configuring Alert Manager

Now we need to configure Alert Manager to handle alerts and send email notifications. This configuration is stored in the `config.yml` file.

#### 2.1 Navigate to the Alert Manager Directory

First, change to the directory where Alert Manager was extracted:

```bash
cd alertmanager-0.25.0.linux-amd64
```

#### 2.2 Edit the Configuration File

Open the `config.yml` file in a text editor such as `vim`:

```bash
vim config.yml
```

Replace `[username]` with your actual username in the following configuration:

```yaml
global:
  resolve_timeout: 5m

route:
  group_by: [Alertname]
  receiver: email-[username]

receivers:
- name: email-[username]
  email_configs:
  - to: "email1@gmail.com"
    from: "email1@gmail.com"
    smarthost: smtp.gmail.com:587
    auth_username: "email1@gmail.com"
    auth_identity: "email1@gmail.com"
    auth_password: "google-app-password"
    send_resolved: True
```

**Explanation**:
- **resolve_timeout**: Alerts are automatically marked as resolved after this time.
- **route**: Specifies how alerts should be routed (by default, based on alert names).
- **receivers**: Defines how and where notifications are sent. In this case, we are setting up email notifications using Gmail.

**Note**: For the `auth_password` field, use a Gmail **App Password**. You can generate this from your Google account by enabling 2-factor authentication (2FA) via [this link](https://myaccount.google.com/signinoptions/two-step-verification) and creating an App Password via [this link](https://myaccount.google.com/u/0/apppasswords).

Here's how to create a app password: [support.google.com](https://support.google.com/mail/answer/185833?hl=en). 

Once the file is configured, save it and exit the editor.

---

### Step 3: Running Alert Manager as a Service

To ensure that Alert Manager runs as a background service and starts on boot, we will configure it to run as a systemd service.

#### 3.1 Create the Alert Manager Service File

Create a new service file for Alert Manager in `/etc/systemd/system/`:

```bash
vim /etc/systemd/system/alert_manager.service
```

Add the following content to define the Alert Manager service:

```ini
[Unit]
Description=Alert Manager

[Service]
User=root
ExecStart=/opt/alertmanager-0.25.0.linux-amd64/alertmanager --config.file=/opt/alertmanager-0.25.0.linux-amd64/config.yml --web.external-url=http://172.16.7.10:9093/ --log.level=debug

[Install]
WantedBy=default.target
```

Save and close the file.

#### 3.2 Reload systemd and Start Alert Manager

After creating the service file, reload systemd to apply the changes:

```bash
systemctl daemon-reload
```

Now, enable and start the Alert Manager service:

```bash
systemctl enable alert_manager.service
systemctl start alert_manager.service
```

#### 3.3 Verify Alert Manager Service Status

To ensure that the Alert Manager service is running correctly, check the status:

```bash
systemctl status alert_manager.service
```

You should see that the service is active and running.

#### 3.4 Check Logs

To view the logs generated by Alert Manager, use the `journalctl` command:

```bash
journalctl -u alert_manager
```

This will display the logs from Alert Manager, helping you debug any potential issues.

---

### Step 4: Accessing Alert Manager

Once the Alert Manager service is running, you can access the Alert Manager UI and metrics.

#### 4.1 Using `curl`

You can access the metrics exposed by Alert Manager using `curl`. Replace `172.16.7.10` with your server’s IP address:

```bash
curl http://172.16.7.10:9093/metrics
curl http://172.16.7.10:9093
curl http://172.16.7.10:9093/#/status
```

#### 4.2 Using a Web Browser

You can also access the Alert Manager interface using a web browser. Open the following URL (replace `10.10.10.11` with your server’s IP):

```
http://10.10.10.11:9093
http://10.10.10.11:9093/#/status
```

You should see the Alert Manager status page, where you can view alert routes and receivers.

---

### Step 5: Configuring Prometheus for Alert Manager

Next, we need to configure **Prometheus** to work with Alert Manager by defining alert rules and connecting to the Alert Manager instance.

#### 5.1 Create Alert Rules

In the Prometheus directory, create a new file for alert rules:

```bash
cd /opt/prometheus-2.44.0.linux-amd64/
vim mysql_rules.yml
```

Add the following configuration to define a rule that triggers an alert when a MySQL instance goes down:

```yaml
groups:
- name: mysql.rules
  rules:
  - alert: Mysql80Down
    expr: mysql_up{job="mysql-[username]"} == 0
    for: 5m
    annotations:
      summary: "Service mysql80 Down"
      description: "Container service mysql80 of job {{ $labels.job }} has been down for more than 5 minutes."
```

This rule alerts when a MySQL instance is down for more than 5 minutes.

#### 5.2 Update Prometheus Configuration

Now, we need to update the Prometheus configuration to integrate Alert Manager and load the new rule file.

Edit the Prometheus configuration:

```bash
vim /opt/prometheus-2.44.0.linux-amd64/config.yml
```

Add the following sections to configure Alert Manager and load the rule file:

```yaml
alerting:
  alertmanagers:
  - static_configs:
    - targets:
      - 172.16.7.10:9093

rule_files:
  - "mysql_rules.yml"
```

Save and close the file.

#### 5.3 Restart Prometheus

To apply the changes, restart the Prometheus server:

```bash
systemctl restart prometheus_server
```

---

### Step 6: Verifying the Setup

Now that Alert Manager and Prometheus are configured, it’s time to verify that everything is working correctly.

#### 6.1 Access Prometheus and Alert Manager

Using a web browser, check the following URLs to verify the configuration:

- Prometheus Configuration: `http://10.10.10.11:9090/config`
- Prometheus Rules: `http://10.10.10.11:9090/rules`
- Prometheus Alerts: `http://10.10.10.11:9090/alerts`
- Alert Manager Status: `http://10.10.10.11:9093/#/status`

Ensure that:
- You can see your **mysql.rules** on the Prometheus Rules page.
- Alerts, like **Mysql80Down**, are visible on the Prometheus Alerts page when triggered.

---

## Conclusion

In this lab, you successfully installed and configured **Alert Manager** on your Linux machine. We covered how to:
1. Install Alert Manager and set up email notifications.
2. Configure Alert Manager to handle alerts from Prometheus.
3. Set up and verify Prometheus integration with Alert Manager.
4. Access and monitor your alerts through the Alert Manager web interface.

With Alert Manager in place, your monitoring setup is now capable of generating and notifying you of critical infrastructure alerts. Congratulations on completing the lab!