# Lab 5.6 - Testing and Verifying Alert Manager

In this lab, we will test and verify the configuration of **Alert Manager** by simulating a MySQL service outage and observing the alert generated by Prometheus. We'll also verify that Alert Manager sends a notification email when the alert is fired.

By the end of this lab, you will:
1. Trigger an alert by stopping the MySQL container.
2. Verify that Prometheus detects the issue and shows an alert in the **FIRING** state.
3. Confirm that Alert Manager sends an email notification.

---

## Step-by-Step Instructions

### Step 1: Stopping the MySQL Container

To test the alert configuration, we'll stop the MySQL container, which should trigger an alert in Prometheus since it monitors MySQL's availability.

1. Run the following command to stop the MySQL container:

   ```bash
   sudo docker stop mysql80
   ```

2. Verify that the MySQL container has stopped:

   ```bash
   docker ps | grep mysql80
   ```

   You should see no output, indicating that the container has been stopped.

---

### Step 2: Checking for Alerts in Prometheus

Once the MySQL container is stopped, Prometheus will detect the outage and generate an alert.

1. Open Prometheus in your browser:

   ```
   http://10.10.10.11:9090/alerts
   ```

2. Look for the alert named `Mysql80Down`. After a few moments, the alert should transition to the **FIRING** state, indicating that the MySQL service is down.

   ![Alert Example](https://via.placeholder.com/600x300?text=Prometheus+Alert+-+Mysql80Down+in+FIRING+State)

   **Note**: It may take a few seconds or minutes for the alert to be fired, depending on your scrape intervals.

---

### Step 3: Checking Your Email for Alert Notification

Once the `Mysql80Down` alert is in the **FIRING** state, Alert Manager will send an email notification to your configured email address.

1. Check your email inbox for a message from Alert Manager. The email will notify you of the **FIRING** alert related to the MySQL container being down.

   Example email content:
   ```
   Alert: Mysql80Down is firing.
   Description: Container service mysql80 of job mysql-[username] has been down for more than 5 minutes.
   ```

2. If you haven't received an email, wait a few more moments. You can also troubleshoot the connection to the email server (see Step 5).

---

## Verification

To ensure everything is working correctly, perform the following checks:

1. **Lab 5.4 and Quiz 1**: Ensure that you have successfully completed **Lab 5.4** (exposing metrics) and **Quiz 1** (configuring Prometheus targets), as this lab builds on the work done there.
   
2. **Alert Status**: Verify that the `Mysql80Down` alert is **FIRING** in the Prometheus alerts page (`http://10.10.10.11:9090/alerts`).

3. **Email Notification**: Confirm that you have received an email notification from Alert Manager about the **FIRING** status of the `Mysql80Down` alert.

---

## Step 4: Troubleshooting Email Notifications

If the alert is **FIRING** in Prometheus but you haven’t received an email, you can check your connection to Gmail’s SMTP server.

### 4.1 Test the Connection to Gmail SMTP

Run the following command to check the connection to Gmail's SMTP server:

```bash
nc -zv smtp.gmail.com 587
```

You should see an output indicating a successful connection to the SMTP server.

### 4.2 Test the Connection Using `curl`

You can also test the SMTP connection using `curl`:

```bash
curl smtp.gmail.com:587
```

If both commands show that the connection is successful, but you still haven’t received an email, try restarting the MySQL container and stopping it again to re-trigger the alert.

### 4.3 Restart MySQL Container

1. Start the MySQL container:

   ```bash
   sudo docker start mysql80
   ```

2. Stop the MySQL container again to re-trigger the alert:

   ```bash
   sudo docker stop mysql80
   ```

This should resend the email notification from Alert Manager.

---

## Conclusion

In this lab, you learned how to test and verify the **Alert Manager** setup by triggering an alert for a stopped MySQL container. You successfully:
1. Stopped the MySQL container to trigger the `Mysql80Down` alert.
2. Verified that the alert was in the **FIRING** state in Prometheus.
3. Checked your email to confirm that Alert Manager sent the alert notification.

If everything works correctly, you are now ready to monitor your infrastructure and receive alert notifications for any critical issues. Congratulations on completing Lab 5.6!